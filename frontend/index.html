<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アレルギー情報登録</title>
</head>
<body>
  <h1>アレルギー情報登録ベータ</h1>
  <form id="allergyForm">
    <label for="name">名前（任意）:</label>
    <input type="text" id="name" name="name" placeholder="例: 山田 太郎"><br><br>

    <label for="allergy">アレルギー対象:</label>
    <input type="text" id="allergy" name="allergy" placeholder="例: ピーナッツ"><br><br>

    <label for="severity">重症度:</label>
    <select id="severity" name="severity">
      <option value="軽度">軽度</option>
      <option value="中程度">中程度</option>
      <option value="重度">重度</option>
    </select><br><br>

    <label for="treatment">対処法:</label>
    <input type="text" id="treatment" name="treatment" placeholder="例: エピペン使用"><br><br>

    <button type="submit">送信</button>
  </form>

  <p id="responseMessage"></p>
  <p id="shareLink"></p>

  <script>
    document.getElementById('allergyForm').addEventListener('submit', async function(event) {
      event.preventDefault(); // ページリロードを防止

      const formData = {
        name: document.getElementById('name').value,
        allergy: document.getElementById('allergy').value,
        severity: document.getElementById('severity').value,
        treatment: document.getElementById('treatment').value,
      };
      try{
        // バックエンドにデータを送信
        const response = await fetch('https://allergy-service-hswx.onrender.com/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        const result = await response.json();
        if (response.ok){
          document.getElementById('responseMessage').textContent = result.message;
          // TODO innerHTMLは安全性に問題あり
          document.getElementById('shareLink').innerHTML = `<a href="${result.link}" target="_blank">共有リンク: ${result.link}</a>`;
        } else {
          document.getElementById('responseMessage').textContent = result.message;
        }
        
        } catch (error){
        console.error('エラーが発生しました');
        document.getElementById('responseMessage').textContent = "エラーが発生しました。再試行してください。";
      }

      
    });
  </script>
</body>
</html>
